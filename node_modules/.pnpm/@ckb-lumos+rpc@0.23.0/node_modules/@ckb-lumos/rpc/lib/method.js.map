{"version":3,"file":"method.js","names":["_exceptions","require","_","_abortController","_interopRequireDefault","_crossFetch","obj","__esModule","default","Method","name","config","options","method","paramsFormatters","resultFormatters","undefined","node","constructor","timeout","DEFAULT_RPC_TIMEOUT","fetch","fetch_","Object","defineProperty","call","value","configurable","writable","params","payload","getPayload","controller","AbortController","signal","setTimeout","abort","res","url","headers","body","JSON","stringify","then","json","_this$options$resultF","_this$options$resultF2","_this$options","id","IdNotMatchException","error","ResponseException","result","clearTimeout","data","map","p","i","Math","round","random","jsonrpc","exports"],"sources":["../src/method.ts"],"sourcesContent":["import { IdNotMatchException, ResponseException } from \"./exceptions\";\nimport { CKBComponents } from \"./types/api\";\nimport { RPCConfig } from \"./types/common\";\nimport { DEFAULT_RPC_TIMEOUT } from \".\";\nimport AbortController from \"abort-controller\";\nimport fetch_ from \"cross-fetch\";\n\nexport class Method {\n  #name: string;\n  #config: RPCConfig;\n\n  get name(): string {\n    return this.#name;\n  }\n\n  #options: CKBComponents.Method = {\n    name: \"\",\n    method: \"\",\n    paramsFormatters: [],\n    resultFormatters: undefined,\n  };\n\n  #node: CKBComponents.Node;\n\n  constructor(\n    node: CKBComponents.Node,\n    options: CKBComponents.Method,\n    config: Partial<RPCConfig> = {}\n  ) {\n    this.#node = node;\n    this.#options = options;\n    this.#name = options.name;\n    const { timeout = DEFAULT_RPC_TIMEOUT, fetch = fetch_ } = config;\n    this.#config = { timeout, fetch };\n\n    Object.defineProperty(this.call, \"name\", {\n      value: options.name,\n      configurable: false,\n      writable: false,\n    });\n  }\n\n  /* eslint-disable @typescript-eslint/ban-types, @typescript-eslint/explicit-module-boundary-types */\n  public call = async (...params: (string | number | object)[]) => {\n    const payload = this.getPayload(...params);\n    const controller = new AbortController();\n    const signal = controller.signal as AbortSignal;\n\n    const timeout = setTimeout(() => controller.abort(), this.#config.timeout);\n\n    const res = await this.#config\n      .fetch(this.#node.url, {\n        method: \"POST\",\n        headers: {\n          \"content-type\": \"application/json\",\n        },\n        body: JSON.stringify(payload),\n        signal,\n      })\n      .then((res) => res.json())\n      .then((res) => {\n        if (res.id !== payload.id) {\n          throw new IdNotMatchException(payload.id, res.id);\n        }\n        if (res.error) {\n          throw new ResponseException(JSON.stringify(res.error));\n        }\n        return this.#options.resultFormatters?.(res.result) ?? res.result;\n      });\n\n    clearTimeout(timeout);\n    return res;\n  };\n\n  public getPayload = (...params: (string | number | object)[]) => {\n    const data = params.map(\n      (p, i) =>\n        (this.#options.paramsFormatters[i] &&\n          this.#options.paramsFormatters[i](p)) ||\n        p\n    );\n    /* eslint-disable @typescript-eslint/no-magic-numbers */\n    const id = Math.round(Math.random() * 10000);\n    const payload = {\n      id,\n      method: this.#options.method,\n      params: data,\n      jsonrpc: \"2.0\",\n    };\n    return payload;\n  };\n}\n/* eslint-enable @typescript-eslint/ban-types, @typescript-eslint/explicit-module-boundary-types */\n"],"mappings":"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","ignoreList":[]}