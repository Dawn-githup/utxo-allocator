var R=/^[0-9a-zA-Z'()+_,\-./:=? ]{0,69}[0-9a-zA-Z'()+_,\-./:=?]$/,x=/;\s*boundary=(?:"([0-9a-zA-Z'()+_,\-./:=? ]{0,69}[0-9a-zA-Z'()+_,\-./:=?])"|([0-9a-zA-Z'+_\-.]{0,69}[0-9a-zA-Z'+_\-.]))/;var G=r=>new ReadableStream({pull(t){if(ArrayBuffer.isView(r))t.enqueue(r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength));else if(r instanceof ArrayBuffer)t.enqueue(r);else throw new TypeError("Expected ArrayBuffer or an ArrayBuffer view.");t.close()}}),f=G;var S=/;\s*boundary=(?:"([^"]+)"|([^;",]+))/,L="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+_-.",O=()=>{let r=new Uint8Array(24);return globalThis.crypto.getRandomValues(r),Array.from(r).map(a=>L[a%L.length]).join("")},g={preventClose:!0};async function*P(r,a,t){let s=new TextEncoder,p=s.encode(`\r
--${r}`);if(Array.isArray(a)&&a.length<1){await t.abort(Error("At least one part is required"));return}let i=0;for await(let e of a){i++;let l,o;if(!e.body&&e.parts)if(o=e.headers.get("content-type"),!o)l=O(),o=`multipart/mixed; boundary="${l}"`;else if(!o.startsWith("multipart/")||!S.test(o)){await t.abort(Error("Invalid multipart content type: "+o));return}else{let y=o.match(x);(!y||!(l=y[1]||y[2]))&&(l=O(),o=o.replace(S,`; boundary="${l}"`))}await f(p).pipeTo(t,g),yield;{let y=[""];if(o){let u=!1;e.headers.forEach((c,d)=>{d!=="content-type"?y.push(`${d}: ${c}`):(u=!0,y.push(`${d}: ${o}`))}),u||y.push(`content-type: ${o}`)}else e.headers.forEach((u,c)=>{y.push(`${c}: ${u}`)});e.parts||!e.body?y.push(""):y.push("","");let T=s.encode(y.join(`\r
`));y.length=0,await f(T).pipeTo(t,g),yield}if(e.body){if(e.body instanceof ArrayBuffer||ArrayBuffer.isView(e.body))await f(e.body).pipeTo(t,g);else if(e.body instanceof Blob)await e.body.stream().pipeTo(t,g);else if(e.body instanceof ReadableStream)await e.body.pipeTo(t,g);else{await t.abort(Error("Invalid body type"));return}yield}else if(e.parts){if(!l){await t.abort(Error("Runtime exception: undefined part boundary"));return}yield*P(l,e.parts,t),yield}}if(!i){await t.abort(Error("At least one part is required"));return}let n=s.encode(`\r
--${r}--`);await f(n).pipeTo(t,g)}var N=(r,a)=>{let t=new TransformStream,s=P(r,a,t.writable),p=!1,i=t.readable.getReader();return new ReadableStream({start(e){(async()=>{for(;;)try{let l=await i.read();if(l.done){let o=new Uint8Array([13,10]);e.enqueue(o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength)),e.close();return}e.enqueue(l.value)}catch(l){e.error(l);return}})().catch(()=>{})},async pull(){if(p)return;(await s.next()).done&&(p=!0,await t.writable.close())}})},_=N;var k=(r,a)=>{e:for(let t=0;t<=r.length-a.length;t++){for(let s=0;s<a.length;s++)if(r[t+s]!==a[s])continue e;return t}return-1},b=k;var U=new TextDecoder,C=new TextEncoder,M=C.encode(`\r
`),q=[9,32],z=r=>{let a=0,t=[];for(;(a=b(r,M))!==-1&&a!==0;){let p=r.indexOf(58);if(p===-1)throw new Error("Invalid header");let i=U.decode(r.subarray(0,p));for(;q.includes(r[a+2]);){let e=b(r.subarray(a+2),M);if(e<1)break;a+=2+e}let n=U.decode(r.subarray(p+1,a)).replace(/\r\n/g,"");t.push([i,n]),r=r.subarray(a+M.length)}let s=new Headers(t);return s.has("content-transfer-encoding")||s.set("content-transfer-encoding","7bit"),s.has("content-type")||s.set("content-type","text/plain; charset=us-ascii"),{headers:s,body:a===-1?null:r.subarray(a+M.length)}},I=z;var Z=(r,...a)=>{let t=a.reduce((i,n)=>i+n.byteLength,r.length),s=new(Object(a[0])).constructor(t);s.set(r);let p=r.length;return a.forEach(i=>{s.set(i,p),p+=i.byteLength}),s},$=Z;async function*v(r,a){var y;if(!R.test(a))throw new Error("Invalid boundary delimiter");let t=new TextEncoder,s=[9,32],p=new Uint8Array([13,10]),i=t.encode(`\r
--${a}`),n=new Uint8Array,e=0,l=!1,o=r.getReader();try{for(;e!==3;){let{done:T,value:u}=await o.read();if(T){if(n.length===0||l)throw new Error("Invalid message");l=!0}else n=$(n,ArrayBuffer.isView(u)?new Uint8Array(u.buffer,u.byteOffset,u.byteLength):new Uint8Array(u));for(;n.length>0;){let c=NaN;if(e===0&&(c=b(n,i.slice(2))-2,c===-3)||(c!==-2&&(c=b(n,i)),c===-1))break;let d=c+i.length,h=T?0:b(n.subarray(d,d+32),p);if(h===-1&&n.length-d<32)break;if(h===-1||!Array.from(n.subarray(d+Math.min(2,h),d+h)).every(w=>s.includes(w)))throw new Error(`Invalid boundary at index ${c}`);if(T||h>=2){if([1,2].includes(e)&&n[d+0]===n[d+1]&&n[d+0]===45)e=3;else if(!s.includes(n[d+0])||!s.includes(n[d+1]))throw new Error(`Invalid boundary at index ${c} (${a}): ${(y=n[d+1])==null?void 0:y.toString(16)}`)}switch(e){case 0:e=1;break;case 1:e=2;case 2:case 3:if(n.subarray(c,d).length>0){let w=n.subarray(0,c),m=I(w),A=m.headers.get("content-type"),E;if(m.body&&(A!=null&&A.startsWith("multipart/"))){let B=A.match(x);if(B){let D=B[1]||B[2];E=v(f(m.body),D)}else E=null}yield{headers:m.headers,body:m.body,...E!==void 0&&{parts:E}}}break}if(e===3){n=n.subarray(n.length);break}n=n.subarray(h+d+2)}}}finally{o.releaseLock()}}var j=v;export{x as boundaryMatchRegex,R as boundaryRegex,j as default,_ as encodeMultipartMessage,I as parseMessage,j as parseMultipartMessage};
